# 108. Creating Charts with HyperCubes
Learning goal: Understand HyperCubes and how they can be used to create charts

<div class="graph"></div>

## What are HyperCubes?
In the previous chapter, we reviewed a special dynamic property called a <code>ListObject</code> that can be used to work with individual fields. There is another dynamic property that is important when working with Engine data: the <code>HyperCube</code>. <code>HyperCubes</code> are used to look at calculated data sets. They allow you to define combinations of dimensions and measures to produce a table of results. These tables are crucial for building charts.

<div id="line-chart-finished" class="graph"></div>

Let’s use our dashboard as an example. In our mockup of the final output, we have a line chart that shows average home listing prices by quarter:
![](108.%20Creating%20Charts%20with%20HyperCubes/line-chart-finished.png)
</br>
</br>

In order to produce this chart, we will need a table of data with 1 column for quarter and 1 column for average home listing prices like so:
<example table of data>

<div id="highlighted-table" class="graph"></div>

Let’s contrast this requirement with our data model. We have a field called Quarter in our calendar table that can be used for our first column. We also have a field for our listing price called Avg Listing Price. However, this field is in a completely different table in our data model. It also isn’t at the level of granularity that we need - the Avg Listing Price is stored at the monthly level by ZipCode. 
<highlight the positions of the two fields in the model>
![](108.%20Creating%20Charts%20with%20HyperCubes/Screen%20Shot%202017-07-05%20at%202.36.05%20PM.png)
</br>
</br>

How do we produce our intended table for our chart? The answer is the HyperCube. The HyperCube can calculate results across tables and aggregate results based on the associations between tables. In our case, we can roll up our listing prices to the quarterly level based on the MonthNum association.
</br>
</br>

The columns in a HyperCube are defined with dimensions and measures. Dimensions are the fields that we want to group our results by. In this example, we want to roll our numbers up to the quarterly level, so Quarter will be a dimension. Measures are formulas that determine how data is calculated and rolled up. Because we want to roll up the Avg Listing Price field into values that are grouped by Quarter, we will write a measure. 
</br>
</br>

Measures have a robust syntax and many built-in functions that can be used. [These functions are detailed in the Help documentation.](http://help.qlik.com/en-US/sense/June2017/Subsystems/Hub/Content/Scripting/functions-in-scripts-chart-expressions.htm) We won’t go into much detail here but instead provide two short examples.
</br>
</br>

One aggregation function available in the QIX Engine is the <code>avg</code> function. This function will calculate an average across any field. If I wanted to get the average of the Avg Listing Price, I could write the following expression:
</br>
<code>=avg(&#91;Avg Listing Price&#93;)</code>

Other common aggregation functions include <code>sum</code>, <code>min</code>, <code>max</code>, and <code>count</code>. 
</br>
</br>

Our expression above is a nice start, but it is not a totally accurate measure of Avg Listing Price when rolled up by Quarter. The original data in our Home Price Trends table is already aggregated to the ZipCode and Month level. In order to calculate a real average at the Quarterly level, we need to use a [weighted average formula](https://en.wikipedia.org/wiki/Weighted_arithmetic_mean). Let’s revise our expression to use the Total Listing Count field to weight our Avg Listing Prices:
<code>=sum(&#91;Avg Listing Price&#93; * &#91;Total Listing Count&#93;)/sum(&#91;Total Listing Count&#93;)</code>
</br>
</br>

This new formula will give us the true average of listing prices when rolled up to higher levels, like Quarter.
</br>
</br>

To recap, we can set up a HyperCube to get our data our line chart with the following parameters:
* Dimension: Quarter
* Measure: <code>=sum(&#91;Avg Listing Price&#93; * &#91;Total Listing Count&#93;)/sum(&#91;Total Listing Count&#93;)</code>

<div class="graph"></div>

## Defining a HyperCube
HyperCubes are added as dynamic properties to Generic Objects just like ListObjects. To add one, we use a <code>qHyperCubeDef</code> property in our Generic Object properties. [The structure of a `HyperCubeDef` is documented here.](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/HyperCubeDef.htm) Like ListObjects, HyperCubes have lots of options. Let’s review the bare minimum properties we need to set for our line chart:
* qDimensions: this property will hold definitions of dimensions for our HyperCube. We will define the Quarter dimension here
* qMeasures: this property will hold definitions of our measures. We will define our average listing price expression here
* qInitialDataFetch: this property will define the page of data that is fetched when <code>getLayout</code> is called. We’ll set up a page so that we see all of the data in our layouts

<div id="chart-cube-editor" class="graph"></div>

Let’s set up a Generic Object definition for this chart. Create a new file called _chart-cube.json_ in the _srcdefs_ folder:
</br>
</br>

We define our dimension in a similar fashion to how we defined a dimension in our ListObjects from the previous chapter. However, a HyperCube can have multiple dimensions so we store the definition in an array under the <code>qDimensions</code> property. 
</br>
</br>

<code>qMeasures</code> takes an array of measure definitions. We’ve filled out an inline definition for a single measure [following the documentation](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxMeasure.htm).
</br>
</br>

Finally, we set up our initial data fetch similar to our ListObject. We only need 2 columns to get our dimension and measure, so we set <code>qWidth</code> to 2. For the <code>qHeight</code>, I picked an arbitrary number that seemed high enough that we would never expect to exceed it. Recall from the previous chapter that data pages have a size limit of 10,000 cells.  Similar to ListObjects, you can manually request more data pages using the <code>GetHyperCubeData</code> method [documented here](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Classes/GenericObjectClass/GenericObject-class-GetHyperCubeData-method.htm).

<div id="index-editor" class="graph"></div>

We can import this definition into our into our <code>index.js</code> file and create a Generic Object with it now. To import it, simply add the definition require statement:

<div id="index-2-editor" class="graph"></div>

Then at the bottom of our file, we can add the script to create a Generic Object with this definition and get its layout:

This code will create the Generic Object, give us a layout for it, and then give us new layouts whenever the Generic Object invalidates. 

<div id="index-3-editor" class="graph"></div>

Our complete _index.js_ file should now look like this:

<div class="graph"></div>

## Parsing a HyperCube Layout
We can parse the layout of a HyperCube in the same way that we parsed the layout of a ListObject. The HyperCube will store its data in a qMatrix within a data page. We can access this qMatrix like so:
</br>
<code>layout.qHyperCube.qDataPages&#91;0&#93;.qMatrix</code>
</br>
</br>

Recall from the previous chapter that the <code>qMatrix</code> is an Array of Arrays. It can be thought of as holding rows. Within those rows are groups of cells. Remember, each cell is a JSON object. That object has several properties to describe the value in that cell. These properties could include:
* qText – a text representation of the cell value
* qNum – a numeric representation of the cell value
* qElemNumber – a rank number of the cell value. For dimensions, this corresponds with the FieldValueIndex of the dimension value, which we can use for selections
* qState – the selection state of the field value
</br>
</br>

There are other properties that you may find in a cell; to learn more, see [NxCell ‒ Qlik Sense](http://help.qlik.com/en-US/sense-developer/3.2/Subsystems/EngineAPI/Content/Structs/NxCell.htm).
</br>
</br>

The HyperCube layout contains other useful information besides the raw data. For example, it will provide us metadata about the dimensions and measures for the cube. This metadata can be valuable for determining chart titles or quickly getting pre-calculated min and max values of measures. [For more on these properties, read up on the HyperCube structure in the documentation.](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/HyperCube.htm)

<div class="graph"></div>

## Sorting the HyperCube
If we examine our <code>qMatrix</code> data, we’ll find that the data is not sorted the way we want it. If we look at the Quarter values in our first cell of each row, we see:
* Q2-2017
* Q1-2017
* Q4-2016
* etc.
</br>
</br>

It looks like our data is sorted in the reverse order that we want. In order to show our time series properly in the line chart, we need the data to be sorted from low to high by Quarter. When the Quarter field was loaded into our data model, a numeric value associated with each quarter based on the start date of the Quarter was provided. Therefore, Qlik can numerically sort this field ascending to produce the order we want. We can modify our dimension definition in our <code>HyperCubeDef</code> to apply this numerical sort order.
</br>
</br>

We are using an inline dimension definition to define “Quarter” as our dimension. [In the documentation for inline dimension definitions](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxInlineDimensionDef.htm), there is a property listed called <code>qSortCriterias</code>. This property can be used to control the sort order of the dimension.
</br>
</br>

<code>qSortCriterias</code> takes an Array of <code>SortCriteria</code>. [The documentation](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/SortCriteria.htm)once again details the properties we can use to define a <code>SortCriteria</code>. The property of interest to us in this instance is <code>qSortByNumeric</code>, which will sort the field values by their numeric value. When setting this property, we can provide a value of:
* -1 for sorting descending
* 0 for no sorting
* 1 for sorting ascending

<div id="chart-cube-2-editor" class="graph"></div>

Let’s update our Generic Object definition to sort the Quarter dimension numeric ascending.

Now our <code>qMatrix</code> will be sorted ascending based on our Quarter dates. We are now ready for visualization!

<div class="graph"></div>

## Visualizing the HyperCube
We have data in our qMatrix that is sorted the way we want. We can now extract this data and create a line chart from it. We can use any charting library we want here. To keep things simple, let’s use a charting package called [C3](http://c3js.org/). C3 is a library built around the lower level visualization toolkit called D3. While D3 gives us granular tools for constructing graphics piece by piece, C3 contains pre-packaged charts with some customization options. We’ll use their line chart to quickly produce our visualization.

<div id="c3-generate-editor" class="graph"></div>

[From the documentation online,](http://c3js.org/samples/categorized.html) we can see that we need to separate our dimension values and our measure values into two separate arrays of strings and numbers to populate our line chart like so:

<div id="index-4-editor" class="graph"></div>

Let’s create a function called <code>renderChart</code> that will extract our data from any layout we get and produce a line chart with c3. First, we need to load c3 as a dependency at the top of our page. We’ll also load a number formatter from the library <code>d3-format</code> that we can use to format our y-axis as money:

<div id="index-5-editor" class="graph"></div>

Next, let’s create our renderChart function at the bottom of our _index.js_ file. In this function, we are going to extract the dimension values into an array of strings and our measure values into an array of numbers from our qMatrix. We will do this with the map function. Then we will feed it into c3 and give our line an appropriate name and provide a money format for the y axis.

<div id="style-editor" class="graph"></div>

We are binding our chart to our <code>#chart</code> element. Let’s update our CSS to set the height and width of our column holding our chart so that it appears nicely next to our filters. Add the following css:

<div id="index-6-editor" class="graph"></div>

Now we just need to use our renderChart function. We want our chart to render any time we get a new layout, so let’s add the <code>renderChart</code> function call to our Generic Object <code>GetLayout</code> callbacks:

<div id="line-chart-initial" class="graph"></div>

Our chart should look like this:
![](108.%20Creating%20Charts%20with%20HyperCubes/line-chart-initial.png)

<div id="chart-cube-3-editor" class="graph"></div>

Notice that we have a null value at the end of our chart. We don’t want this value. Fortunately, we can easily modify our <code>HyperCubeDef</code> to suppress null values in the Quarter dimension. In the [documentation](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxDimension.htm) for <code>NxDimension</code>, there is a property called <code>qNullSuppression</code> that we can set to <code>true</code> to remove our nulls. Let’s update our Generic Object definition to include that property in the Quarter dimension:

<div id="line-chart-no-null" class="graph"></div>

Now we should have a nice line chart with no null values.
![](108.%20Creating%20Charts%20with%20HyperCubes/line-chart-no-null.png)

Use our listboxes from before to filter the data and watch the chart update. We’ve successfully created a dashboard with the QIX Engine. Congrats!

<div class="graph"></div>

## Fin
#### Resources
* [Qlik Aggregation Functions](http://help.qlik.com/en-US/sense/June2017/Subsystems/Hub/Content/Scripting/functions-in-scripts-chart-expressions.htm)
* [HyperCubeDef spec](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/HyperCubeDef.htm)
* [NxMeasure spec](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxMeasure.htm)
* [NxDimension spec](http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxInlineDimensionDef.htm)
* [C3 Example Chart](http://c3js.org/samples/categorized.html)

