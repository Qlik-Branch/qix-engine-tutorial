<div id="section-0"class="section "><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <h2>What are HyperCubes?</h2><p>In the previous chapter, we reviewed a special dynamic property called a ListObject that can be used to work with individual fields. There is another dynamic property that is important when working with Engine data: the HyperCube. HyperCubes are used to look at calculated data sets. They allow you to define combinations of dimensions and measures to produce a table of results. These tables are crucial for building charts.</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph"></div></div></div></div><div id="section-1"class="section line-chart-finished"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Let’s use our dashboard as an example. In our mockup of the final output, we have a line chart that shows average home listing prices by quarter:</br></br></p><p>In order to produce this chart, we will need a table of data with 1 column for quarter and 1 column for average home listing prices like so:<example table of data></p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="line-chart-finished"></div></div></div></div><div id="section-2"class="section highlighted-table"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Let’s contrast this requirement with our data model. We have a field called Quarter in our calendar table that can be used for our first column. We also have a field for our listing price called Avg Listing Price. However, this field is in a completely different table in our data model. It also isn’t at the level of granularity that we need - the Avg Listing Price is stored at the monthly level by ZipCode.<highlight the positions of the two fields in the model></br></br></p><p>How do we produce our intended table for our chart? The answer is the HyperCube. The HyperCube can calculate results across tables and aggregate results based on the associations between tables. In our case, we can roll up our listing prices to the quarterly level based on the MonthNum association.</br></br></p><p>The columns in a HyperCube are defined with dimensions and measures. Dimensions are the fields that we want to group our results by. In this example, we want to roll our numbers up to the quarterly level, so Quarter will be a dimension. Measures are formulas that determine how data is calculated and rolled up. Because we want to roll up the Avg Listing Price field into values that are grouped by Quarter, we will write a measure.</br></br></p><p>Measures have a robust syntax and many built-in functions that can be used. <a href="http://help.qlik.com/en-US/sense/June2017/Subsystems/Hub/Content/Scripting/functions-in-scripts-chart-expressions.htm">These functions are detailed in the Help documentation.</a> We won’t go into much detail here but instead provide two short examples.</br></br></p><p>One aggregation function available in the QIX Engine is the avg function. This function will calculate an average across any field. If I wanted to get the average of the Avg Listing Price, I could write the following expression:</br><code>=avg([Avg Listing Price])</code></p><p>Other common aggregation functions include <code>sum</code>, <code>min</code>, <code>max</code>, and <code>count</code>.</br></br></p><p>Our expression above is a nice start, but it is not a totally accurate measure of Avg Listing Price when rolled up by Quarter. The original data in our Home Price Trends table is already aggregated to the ZipCode and Month level. In order to calculate a real average at the Quarterly level, we need to use a <a href="https://en.wikipedia.org/wiki/Weighted_arithmetic_mean">weighted average formula</a>. Let’s revise our expression to use the Total Listing Count field to weight our Avg Listing Prices:<code>=sum([Avg Listing Price] * [Total Listing Count])/sum([Total Listing Count])</code></br></br></p><p>This new formula will give us the true average of listing prices when rolled up to higher levels, like Quarter.</br></br></p><p>To recap, we can set up a HyperCube to get our data our line chart with the following parameters:</p><ul><li><p>Dimension: Quarter</p></li><li><p>Measure: <code>=sum([Avg Listing Price] * [Total Listing Count])/sum([Total Listing Count])</code></p></li></ul></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="highlighted-table"></div></div></div></div><div id="section-3"class="section "><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <h2>Defining a HyperCube</h2><p>HyperCubes are added as dynamic properties to Generic Objects just like ListObjects. To add one, we use a qHyperCubeDef property in our Generic Object properties. <a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/HyperCubeDef.htm">The structure of a HyperCubeDef is documented here.</a> Like ListObjects, HyperCubes have lots of options. Let’s review the bare minimum properties we need to set for our line chart:</p><ul><li><p>qDimensions: this property will hold definitions of dimensions for our HyperCube. We will define the Quarter dimension here</p></li><li><p>qMeasures: this property will hold definitions of our measures. We will define our average listing price expression here</p></li><li><p>qInitialDataFetch: this property will define the page of data that is fetched when getLayout is called. We’ll set up a page so that we see all of the data in our layouts</p></li></ul></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph"></div></div></div></div><div id="section-4"class="section chart-cube-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Let’s set up a Generic Object definition for this chart. Create a new file called <em>chart-cube.json</em> in the <em>srcdefs</em> folder:</br></br></p><p>We define our dimension in a similar fashion to how we defined a dimension in our ListObjects from the previous chapter. However, a HyperCube can have multiple dimensions so we store the definition in an array under the qDimensions property.</br></br></p><p>qMeasures takes an array of measure definitions. We’ve filled out an inline definition for a single measure <a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxMeasure.htm">following the documentation</a>.</br></br></p><p>Finally, we set up our initial data fetch similar to our ListObject. We only need 2 columns to get our dimension and measure, so we set qWidth to 2. For the qHeight, I picked an arbitrary number that seemed high enough that we would never expect to exceed it. Recall from the previous chapter that data pages have a size limit of 10,000 cells.  Similar to ListObjects, you can manually request more data pages using the GetHyperCubeData method <a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Classes/GenericObjectClass/GenericObject-class-GetHyperCubeData-method.htm">documented here</a>.</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="chart-cube-editor"></div></div></div></div><div id="section-5"class="section index-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>We can import this definition into our into our index.js file and create a Generic Object with it now. To import it, simply add the definition require statement:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="index-editor"></div></div></div></div><div id="section-6"class="section index-2-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Then at the bottom of our file, we can add the script to create a Generic Object with this definition and get its layout:</p><p>This code will create the Generic Object, give us a layout for it, and then give us new layouts whenever the Generic Object invalidates.</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="index-2-editor"></div></div></div></div><div id="section-7"class="section index-3-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Our complete <em>index.js</em> file should now look like this:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="index-3-editor"></div></div></div></div><div id="section-8"class="section "><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <h2>Parsing a HyperCube Layout</h2><p>We can parse the layout of a HyperCube in the same way that we parsed the layout of a ListObject. The HyperCube will store its data in a qMatrix within a data page. We can access this qMatrix like so:</br><code>layout.qHyperCube.qDataPages[0].qMatrix</code></br></br></p><p>Recall from the previous chapter that the qMatrix is an Array of Arrays. It can be thought of as holding rows. Within those rows are groups of cells. Remember, each cell is a JSON object. That object has several properties to describe the value in that cell. These properties could include:</p><ul><li><p>qText – a text representation of the cell value</p></li><li><p>qNum – a numeric representation of the cell value</p></li><li><p>qElemNumber – a rank number of the cell value. For dimensions, this corresponds with the FieldValueIndex of the dimension value, which we can use for selections</p></li><li><p>qState – the selection state of the field value</br></br></p></li></ul><p>There are other properties that you may find in a cell; to learn more, see <a href="http://help.qlik.com/en-US/sense-developer/3.2/Subsystems/EngineAPI/Content/Structs/NxCell.htm">NxCell ‒ Qlik Sense</a>.</br></br></p><p>The HyperCube layout contains other useful information besides the raw data. For example, it will provide us metadata about the dimensions and measures for the cube. This metadata can be valuable for determining chart titles or quickly getting pre-calculated min and max values of measures. <a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/HyperCube.htm">For more on these properties, read up on the HyperCube structure in the documentation.</a></p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph"></div></div></div></div><div id="section-9"class="section "><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <h2>Sorting the HyperCube</h2><p>If we examine our qMatrix data, we’ll find that the data is not sorted the way we want it. If we look at the Quarter values in our first cell of each row, we see:</p><ul><li><p>Q2-2017</p></li><li><p>Q1-2017</p></li><li><p>Q4-2016</p></li><li><p>etc.</br></br></p></li></ul><p>It looks like our data is sorted in the reverse order that we want. In order to show our time series properly in the line chart, we need the data to be sorted from low to high by Quarter. When the Quarter field was loaded into our data model, a numeric value associated with each quarter based on the start date of the Quarter was provided. Therefore, Qlik can numerically sort this field ascending to produce the order we want. We can modify our dimension definition in our HyperCubeDef to apply this numerical sort order.</br></br></p><p>We are using an inline dimension definition to define “Quarter” as our dimension. <a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxInlineDimensionDef.htm">In the documentation for inline dimension definitions</a>, there is a property listed called qSortCriterias. This property can be used to control the sort order of the dimension.</br></br></p><p>qSortCriterias takes an Array of SortCriteria. <a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/SortCriteria.htm">The documentation</a>once again details the properties we can use to define a SortCriteria. The property of interest to us in this instance is qSortByNumeric, which will sort the field values by their numeric value. When setting this property, we can provide a value of:</p><ul><li><p>-1 for sorting descending</p></li><li><p>0 for no sorting</p></li><li><p>1 for sorting ascending</p></li></ul></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph"></div></div></div></div><div id="section-10"class="section chart-cube-2-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Let’s update our Generic Object definition to sort the Quarter dimension numeric ascending.</p><p>Now our qMatrix will be sorted ascending based on our Quarter dates. We are now ready for visualization!</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="chart-cube-2-editor"></div></div></div></div><div id="section-11"class="section "><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <h2>Visualizing the HyperCube</h2><p>We have data in our qMatrix that is sorted the way we want. We can now extract this data and create a line chart from it. We can use any charting library we want here. To keep things simple, let’s use a charting package called <a href="http://c3js.org/">C3</a>. C3 is a library built around the lower level visualization toolkit called D3. While D3 gives us granular tools for constructing graphics piece by piece, C3 contains pre-packaged charts with some customization options. We’ll use their line chart to quickly produce our visualization.</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph"></div></div></div></div><div id="section-12"class="section c3-generate-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p><a href="http://c3js.org/samples/categorized.html">From the documentation online,</a> we can see that we need to separate our dimension values and our measure values into two separate arrays of strings and numbers to populate our line chart like so:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="c3-generate-editor"></div></div></div></div><div id="section-13"class="section index-4-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Let’s create a function called renderChart that will extract our data from any layout we get and produce a line chart with c3. First, we need to load c3 as a dependency at the top of our page. We’ll also load a number formatter from the library d3-format that we can use to format our y-axis as money:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="index-4-editor"></div></div></div></div><div id="section-14"class="section index-5-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Next, let’s create our renderChart function at the bottom of our <em>index.js</em> file. In this function, we are going to extract the dimension values into an array of strings and our measure values into an array of numbers from our qMatrix. We will do this with the map function. Then we will feed it into c3 and give our line an appropriate name and provide a money format for the y axis.</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="index-5-editor"></div></div></div></div><div id="section-15"class="section style-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>We are binding our chart to our #chart element. Let’s update our CSS to set the height and width of our column holding our chart so that it appears nicely next to our filters. Add the following css:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="style-editor"></div></div></div></div><div id="section-16"class="section index-6-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Now we just need to use our renderChart function. We want our chart to render any time we get a new layout, so let’s add the renderChart function call to our Generic Object GetLayout callbacks:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="index-6-editor"></div></div></div></div><div id="section-17"class="section line-chart-initial"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Our chart should look like this:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="line-chart-initial"></div></div></div></div><div id="section-18"class="section chart-cube-3-editor"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Notice that we have a null value at the end of our chart. We don’t want this value. Fortunately, we can easily modify our HyperCubeDef to suppress null values in the Quarter dimension. In the <a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxDimension.htm">documentation</a> for NxDimension, there is a property called qNullSuppression that we can set to true to remove our nulls. Let’s update our Generic Object definition to include that property in the Quarter dimension:</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="chart-cube-3-editor"></div></div></div></div><div id="section-19"class="section line-chart-no-null"><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <p>Now we should have a nice line chart with no null values.</p><p>Use our listboxes from before to filter the data and watch the chart update. We’ve successfully created a dashboard with the QIX Engine. Congrats!</p></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph" id="line-chart-no-null"></div></div></div></div><div id="section-20"class="section "><div class="row">
          <div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-left">
    <h2>Fin</h2><h4>Resources</h4><ul><li><p><a href="http://help.qlik.com/en-US/sense/June2017/Subsystems/Hub/Content/Scripting/functions-in-scripts-chart-expressions.htm">Qlik Aggregation Functions</a></p></li><li><p><a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/HyperCubeDef.htm">HyperCubeDef spec</a></p></li><li><p><a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxMeasure.htm">NxMeasure spec</a></p></li><li><p><a href="http://help.qlik.com/en-US/sense-developer/June2017/Subsystems/EngineAPI/Content/Structs/NxInlineDimensionDef.htm">NxDimension spec</a></p></li><li><p><a href="http://c3js.org/samples/categorized.html">C3 Example Chart</a></p></li></ul></div><div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 body-right"><div class="graph"></div></div></div></div>